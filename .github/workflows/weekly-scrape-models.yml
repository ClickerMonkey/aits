name: Weekly Model Scraper

on:
  # Run every Sunday at 00:00 UTC
  schedule:
    - cron: '0 0 * * 0'
  
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  scrape-models:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run model scrapers with metrics
        run: |
          cd packages/models
          npm run scrape -- --metrics
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          REPLICATE_API_KEY: ${{ secrets.REPLICATE_API_KEY }}
      
      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code || echo "has_changes=true" >> $GITHUB_OUTPUT
      
      - name: Create or update pull request
        if: steps.git-check.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update model information and metrics'
          branch: automated/weekly-model-scrape
          delete-branch: true
          title: 'chore: Weekly model information update'
          body: |
            ## Automated Model Information Update
            
            This PR contains the latest model information and metrics scraped from:
            - OpenAI
            - OpenRouter
            - Replicate
            - AWS Bedrock
            
            The scrapers were run on: ${{ github.event.repository.updated_at }}
            
            ### Changes
            - Updated model definitions with latest information
            - Refreshed performance metrics (latency, throughput, uptime)
            - Updated pricing information where available
            
            This is an automated PR generated by the weekly model scraper workflow.
          labels: |
            automated
            dependencies
            models
